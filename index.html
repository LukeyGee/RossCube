<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Jumpstart Deck Generator</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #f0f4f8 0%, #d9e2ec 100%);
        }
        .btn {
            @apply px-6 py-3 bg-sky-600 text-white font-semibold rounded-lg shadow-md hover:bg-sky-700 focus:outline-none focus:ring-2 focus:ring-sky-500 focus:ring-opacity-75 transition-colors duration-150 ease-in-out disabled:opacity-50 disabled:cursor-not-allowed;
        }
        .btn-secondary {
            @apply px-4 py-2 bg-slate-500 text-white font-medium rounded-lg shadow-sm hover:bg-slate-600 focus:outline-none focus:ring-2 focus:ring-slate-400 focus:ring-opacity-75 transition-colors duration-150 ease-in-out;
        }
        .card {
            @apply bg-white p-6 rounded-xl shadow-lg;
        }
        /* Basic styling for the label next to the visible radio button */
        .pack-radio-label {
            @apply ml-2 cursor-pointer; /* Add margin to space it from the radio button */
        }
        /* Style the container for each radio + label pair if needed */
        .radio-option-item {
            @apply flex items-center p-2 border border-slate-200 rounded-lg hover:bg-slate-50;
        }


        #decklistOutput::-webkit-scrollbar {
            width: 8px;
        }
        #decklistOutput::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: 10px;
        }
        #decklistOutput::-webkit-scrollbar-thumb {
            background: #888;
            border-radius: 10px;
        }
        #decklistOutput::-webkit-scrollbar-thumb:hover {
            background: #555;
        }
        .message-box {
            @apply fixed top-5 right-5 p-4 rounded-lg shadow-md text-white z-50;
        }
        .message-box-success { @apply bg-green-500; }
        .message-box-error { @apply bg-red-500; }
        .message-box-info { @apply bg-blue-500; }
    </style>
</head>
<body class="min-h-screen flex flex-col items-center justify-center p-4 selection:bg-sky-300 selection:text-sky-900">

    <div id="messageContainer" class="fixed top-5 right-5 z-50"></div>

    <div class="card w-full max-w-2xl space-y-6">
        <header class="text-center">
            <h1 class="text-3xl font-bold text-slate-800">Jumpstart Deck Generator</h1>
            <p class="text-slate-600 mt-1">Select a cube and two packs to generate your deck!</p>
        </header>

        <!-- Step 1: Cube Selection -->
        <section id="cubeSelectionStep">
            <h2 class="text-xl font-semibold text-slate-700 mb-3">Step 1: Select a Cube</h2>
            <div class="space-y-2">
                <p class="text-sm text-slate-500">The first 6 are general cubes (trs is largest). 1zgb3 is Old School. vuq & 1rxve are beginner cubes.</p>
                <select id="cubeSelect" class="w-full p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 transition-shadow">
                    <option value="">-- Choose a Cube --</option>
                </select>
            </div>
            <button id="confirmCubeBtn" class="btn mt-4 w-full" disabled>Load Packs from Cube</button>
        </section>

        <!-- Step 2: Pack Selection -->
        <section id="packSelectionStep" class="hidden space-y-4">
            <div>
                <h2 id="packSelectionTitle" class="text-xl font-semibold text-slate-700 mb-1">Step 2: Choose Your First Pack</h2>
                <p class="text-sm text-slate-500">Selected Cube: <span id="selectedCubeName" class="font-semibold"></span></p>
            </div>
            <div id="packOptionsContainer" class="space-y-2"> <!-- Single column for simpler layout -->
                <!-- Pack options (visible radio buttons) will be injected here -->
            </div>
            <div class="flex space-x-3 mt-4">
                <button id="confirmPackBtn" class="btn flex-grow" disabled>Confirm Pack</button>
                <button id="resetAppBtnPack" class="btn-secondary">Start Over</button>
            </div>
        </section>

        <!-- Step 3: Decklist Display -->
        <section id="decklistStep" class="hidden space-y-4">
            <h2 class="text-xl font-semibold text-slate-700 mb-1">Step 3: Your Decklist</h2>
            <p class="text-sm text-slate-500">
                Packs: <span id="chosenPack1" class="font-semibold text-sky-700"></span> & 
                <span id="chosenPack2" class="font-semibold text-sky-700"></span>
                from cube <span id="chosenCubeCode" class="font-semibold text-green-700"></span>.
            </p>
            <textarea id="decklistOutput" readonly class="w-full h-64 p-3 border border-slate-300 rounded-lg focus:ring-2 focus:ring-sky-500 focus:border-sky-500 resize-none bg-slate-50" placeholder="Generating decklist..."></textarea>
            <div class="flex flex-col sm:flex-row space-y-3 sm:space-y-0 sm:space-x-3">
                <button id="copyDecklistBtn" class="btn flex-grow">Copy Decklist to Clipboard</button>
                <button id="printToConsoleBtn" class="btn-secondary flex-grow">Print to Console (for dev)</button>
                <button id="resetAppBtnDeck" class="btn-secondary">Start Over</button>
            </div>
        </section>

        <!-- Loading Indicator -->
        <div id="loadingIndicator" class="hidden text-center py-4">
            <div class="inline-flex items-center text-slate-600">
                <svg class="animate-spin -ml-1 mr-3 h-5 w-5 text-sky-600" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24">
                    <circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle>
                    <path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path>
                </svg>
                Processing... Please wait.
            </div>
        </div>
    </div>

    <footer class="text-center mt-8 text-sm text-slate-500">
        <p>Ported from a PowerShell script. Cube data from <a href="https://cubecobra.com/" target="_blank" rel="noopener noreferrer" class="text-sky-600 hover:underline">CubeCobra</a>.</p>
    </footer>

<script>
    // --- DOM Elements ---
    const cubeSelect = document.getElementById('cubeSelect');
    const confirmCubeBtn = document.getElementById('confirmCubeBtn');
    const packSelectionTitle = document.getElementById('packSelectionTitle');
    const selectedCubeName = document.getElementById('selectedCubeName');
    const packOptionsContainer = document.getElementById('packOptionsContainer');
    const confirmPackBtn = document.getElementById('confirmPackBtn');
    const decklistOutput = document.getElementById('decklistOutput');
    const copyDecklistBtn = document.getElementById('copyDecklistBtn');
    const printToConsoleBtn = document.getElementById('printToConsoleBtn');
    
    const cubeSelectionStep = document.getElementById('cubeSelectionStep');
    const packSelectionStep = document.getElementById('packSelectionStep');
    const decklistStep = document.getElementById('decklistStep');
    const loadingIndicator = document.getElementById('loadingIndicator');
    
    const chosenPack1Display = document.getElementById('chosenPack1');
    const chosenPack2Display = document.getElementById('chosenPack2');
    const chosenCubeCodeDisplay = document.getElementById('chosenCubeCode');
    const messageContainer = document.getElementById('messageContainer');

    // --- Application State ---
    let cubes = [
        { name: "MADChilupa Big Vintage", code: "trs", url: "https://cubecobra.com/cube/overview/trs" },
        { name: "KaramjaRum Super Jump", code: "krstart1", url: "https://cubecobra.com/cube/overview/krstart1" },
        { name: "ImNotFine Jumpstart Cube", code: "infjumpstartcube", url: "https://cubecobra.com/cube/overview/infjumpstartcube" },
        { name: "Aerac Jumpstart Cube", code: "ajsc", url: "https://cubecobra.com/cube/overview/ajsc" },
        { name: "aquickalias Jumpstart", code: "jumpstartdecks", url: "https://cubecobra.com/cube/overview/jumpstartdecks" },
        { name: "Jumpstart Cube 900", code: "jump-start-cube", url: "https://cubecobra.com/cube/overview/jump-start-cube" },
        { name: "Old School Jumpstart (1996 & earlier)", code: "1zgb3", url: "https://cubecobra.com/cube/overview/1zgb3" },
        { name: "Big Beginner Jumpstart", code: "vuq", url: "https://cubecobra.com/cube/overview/vuq" },
        { name: "Small Beginner Jumpstart", code: "1rxve", url: "https://cubecobra.com/cube/overview/1rxve" }
    ];
    let currentCubeData = null;
    let availablePackThemes = []; 
    let packSelections = { pack1: null, pack2: null };
    let currentPackOptions = [];

    // --- Helper Functions ---
    function showMessage(message, type = 'info', duration = 3000) {
        const messageDiv = document.createElement('div');
        messageDiv.textContent = message;
        messageDiv.className = `message-box message-box-${type} animate-pulse`;
        messageContainer.appendChild(messageDiv);
        setTimeout(() => {
            messageDiv.classList.remove('animate-pulse');
            messageDiv.style.transition = 'opacity 0.5s ease-out';
            messageDiv.style.opacity = '0';
            setTimeout(() => messageDiv.remove(), 500);
        }, duration - 500);
    }

    function parseCSV(csvText) {
        const lines = csvText.trim().split('\n');
        if (lines.length < 1) return [];
        const headers = lines[0].split(',').map(header => header.trim().replace(/^"|"$/g, ''));
        const data = [];
        for (let i = 1; i < lines.length; i++) {
            const values = [];
            let currentLine = lines[i];
            let inQuotes = false;
            let currentValue = '';
            for (let charIndex = 0; charIndex < currentLine.length; charIndex++) {
                const char = currentLine[charIndex];
                if (char === '"') {
                    if (inQuotes && charIndex + 1 < currentLine.length && currentLine[charIndex + 1] === '"') {
                        currentValue += '"';
                        charIndex++; 
                    } else {
                        inQuotes = !inQuotes;
                    }
                } else if (char === ',' && !inQuotes) {
                    values.push(currentValue.trim());
                    currentValue = '';
                } else {
                    currentValue += char;
                }
            }
            values.push(currentValue.trim()); 
            if (values.length === headers.length) {
                const entry = {};
                headers.forEach((header, index) => {
                    entry[header] = values[index] ? values[index].replace(/^"|"$/g, '') : '';
                });
                data.push(entry);
            }
        }
        return data;
    }

    function setLoading(isLoading) {
        if (isLoading) {
            loadingIndicator.classList.remove('hidden');
            confirmCubeBtn.disabled = true;
            confirmPackBtn.disabled = true; 
            copyDecklistBtn.disabled = true;
        } else {
            loadingIndicator.classList.add('hidden');
        }
    }

    function populateCubeSelect() {
        cubes.forEach(cube => {
            const option = document.createElement('option');
            option.value = cube.code;
            option.textContent = cube.name;
            cubeSelect.appendChild(option);
        });
    }

    async function fetchAndProcessCube(cubeCode) {
        setLoading(true);
        const cube = cubes.find(c => c.code === cubeCode);
        if (!cube) {
            showMessage('Selected cube not found.', 'error');
            setLoading(false);
            return;
        }
        selectedCubeName.textContent = cube.name;
        const csvUrl = `https://cubecobra.com/cube/download/csv/${cubeCode}`;
        const proxyUrl = `https://corsproxy.io/?${encodeURIComponent(csvUrl)}`;
        try {
            const response = await fetch(proxyUrl); 
            if (!response.ok) throw new Error(`Failed to fetch cube CSV: ${response.status} ${response.statusText}`);
            const csvText = await response.text();
            currentCubeData = parseCSV(csvText);
            if (!currentCubeData || currentCubeData.length === 0) throw new Error('Cube data is empty or could not be parsed.');
            extractPackThemes();
            transitionToPackSelection(1); 
            showMessage(`Loaded ${cube.name} with ${currentCubeData.length} cards.`, 'success');
        } catch (error) {
            showMessage(`Error: ${error.message}. Try selecting another cube.`, 'error', 5000);
            currentCubeData = null;
            resetToCubeSelection(); 
        } finally {
            setLoading(false);
            confirmCubeBtn.disabled = !cubeSelect.value;
        }
    }

    function extractPackThemes() {
        if (!currentCubeData) return;
        const themes = new Set();
        currentCubeData.forEach(card => {
            const cardTags = card.Tags || card.tags; 
            if (cardTags && cardTags.trim() !== "" && cardTags !== "Other" && cardTags !== "B - The Big Top") {
                themes.add(cardTags.trim());
            }
        });
        availablePackThemes = Array.from(themes).sort();
    }

    function displayPackChoices(packNumber) {
        packOptionsContainer.innerHTML = ''; 
        confirmPackBtn.disabled = true; 
        let themesToOffer;

        if (packNumber === 1) {
            packSelections.pack1 = null; 
            packSelections.pack2 = null; 
            const shuffledThemes = [...availablePackThemes].sort(() => 0.5 - Math.random());
            themesToOffer = shuffledThemes.slice(0, Math.min(6, availablePackThemes.length));
            if (availablePackThemes.length < 6 && availablePackThemes.length > 0) {
                 showMessage(`Info: Only ${availablePackThemes.length} unique pack themes available.`, 'info', 4000);
            }
            currentPackOptions = themesToOffer;
        } else { 
            packSelections.pack2 = null; 
            themesToOffer = currentPackOptions.filter(theme => theme !== packSelections.pack1);
        }
        
        if (themesToOffer.length === 0) {
            showMessage('No more pack themes. Try resetting or a different cube.', 'error', 5000);
            confirmPackBtn.disabled = true;
            return;
        }

        themesToOffer.forEach((theme, index) => {
            const radioId = `pack_theme_${packNumber}_${index}`;
            const radioName = `pack_selection_group_${packNumber}`;

            const optionDiv = document.createElement('div'); 
            optionDiv.classList.add('radio-option-item'); // Add class for each radio+label container

            const radioInput = document.createElement('input');
            radioInput.type = 'radio';
            radioInput.id = radioId;
            radioInput.name = radioName;
            radioInput.value = theme;
            // radioInput.classList.add('sr-only'); // Ensure this is commented out or removed
            radioInput.onchange = () => handlePackSelectionChange(theme, packNumber);

            const label = document.createElement('label');
            label.htmlFor = radioId;
            label.textContent = `${index + 1}: ${theme}`;
            label.classList.add('pack-radio-label');

            optionDiv.appendChild(radioInput);
            optionDiv.appendChild(label);    
            packOptionsContainer.appendChild(optionDiv);
        });
    }

    function handlePackSelectionChange(theme, packNumber) {
        if (packNumber === 1) {
            packSelections.pack1 = theme;
        } else { 
            packSelections.pack2 = theme;
        }
        confirmPackBtn.disabled = false; 
    }

    function generateDecklist() {
        if (!currentCubeData || !packSelections.pack1 || !packSelections.pack2) {
            showMessage('Cannot generate decklist: Missing data or pack selections.', 'error');
            return;
        }
        setLoading(true);
        const deck = [];
        currentCubeData.forEach(card => {
            const cardTags = card.Tags || card.tags; 
            if (cardTags === packSelections.pack1 || cardTags === packSelections.pack2) {
                deck.push(card.Name || card.name); 
            }
        });
        decklistOutput.value = deck.sort().join('\n');
        chosenPack1Display.textContent = packSelections.pack1;
        chosenPack2Display.textContent = packSelections.pack2;
        chosenCubeCodeDisplay.textContent = cubeSelect.value;
        transitionToDecklistDisplay();
        showMessage('Decklist generated!', 'success');
        setLoading(false);
        copyDecklistBtn.disabled = false;
    }

    // --- UI Transitions ---
    function resetToCubeSelection() {
        cubeSelectionStep.classList.remove('hidden');
        packSelectionStep.classList.add('hidden');
        decklistStep.classList.add('hidden');
        loadingIndicator.classList.add('hidden');
        cubeSelect.value = "";
        confirmCubeBtn.disabled = true;
        currentCubeData = null;
        availablePackThemes = [];
        packSelections = { pack1: null, pack2: null };
        currentPackOptions = [];
        packOptionsContainer.innerHTML = '';
        decklistOutput.value = '';
        selectedCubeName.textContent = '';
        chosenPack1Display.textContent = '';
        chosenPack2Display.textContent = '';
        chosenCubeCodeDisplay.textContent = '';
        showMessage('App Reset. Please select a cube.', 'info');
    }

    function transitionToPackSelection(packNumber) {
        cubeSelectionStep.classList.add('hidden');
        packSelectionStep.classList.remove('hidden');
        decklistStep.classList.add('hidden');
        packSelectionTitle.textContent = `Step 2: Choose Your ${packNumber === 1 ? 'First' : 'Second'} Pack`;
        displayPackChoices(packNumber); 
    }

    function transitionToDecklistDisplay() {
        packSelectionStep.classList.add('hidden');
        decklistStep.classList.remove('hidden');
    }

    // --- Event Listeners ---
    document.addEventListener('DOMContentLoaded', () => {
        populateCubeSelect();
        document.getElementById('resetAppBtnPack').addEventListener('click', resetToCubeSelection);
        document.getElementById('resetAppBtnDeck').addEventListener('click', resetToCubeSelection);
    });

    cubeSelect.addEventListener('change', () => {
        confirmCubeBtn.disabled = !cubeSelect.value;
    });

    confirmCubeBtn.addEventListener('click', () => {
        if (cubeSelect.value) {
            fetchAndProcessCube(cubeSelect.value);
        }
    });

    confirmPackBtn.addEventListener('click', () => {
        if (packSelections.pack1 && !packSelections.pack2) {
            if (!currentPackOptions.some(theme => theme === packSelections.pack1)) {
                 showMessage('Invalid first pack selection. Please pick from the list.', 'error');
                 packSelections.pack1 = null; 
                 confirmPackBtn.disabled = true;
                 const radioGroup = document.getElementsByName('pack_selection_group_1');
                 if (radioGroup) radioGroup.forEach(radio => radio.checked = false);
                 return;
            }
            transitionToPackSelection(2); 
        } 
        else if (packSelections.pack1 && packSelections.pack2) {
            const validSecondPackOptions = currentPackOptions.filter(theme => theme !== packSelections.pack1);
            if (!validSecondPackOptions.some(theme => theme === packSelections.pack2)) {
                showMessage('Invalid second pack selection. Please pick from the list.', 'error');
                packSelections.pack2 = null; 
                confirmPackBtn.disabled = true; 
                const radioGroup = document.getElementsByName('pack_selection_group_2');
                if (radioGroup) radioGroup.forEach(radio => radio.checked = false);
                return;
            }
            generateDecklist();
        } else {
            showMessage('Please select a pack.', 'info');
        }
    });

    copyDecklistBtn.addEventListener('click', () => {
        if (decklistOutput.value) {
            const textarea = document.createElement('textarea');
            textarea.value = decklistOutput.value;
            document.body.appendChild(textarea);
            textarea.select();
            try {
                document.execCommand('copy');
                showMessage('Decklist copied to clipboard!', 'success');
            } catch (err) {
                navigator.clipboard.writeText(decklistOutput.value)
                    .then(() => showMessage('Decklist copied to clipboard! (fallback)', 'success'))
                    .catch(navErr => {
                        showMessage('Failed to copy. Try manual copy.', 'error', 5000);
                    });
            }
            document.body.removeChild(textarea);
        }
    });
    
    printToConsoleBtn.addEventListener('click', () => {
        if (decklistOutput.value) {
            showMessage('Decklist printed to browser console (if console logging is enabled).', 'info');
        } else {
            showMessage('No decklist to print.', 'info');
        }
    });

</script>
</body>
</html>
